
const sql = require("./db.js");

const Ahdlist = function (ahdlist) {
    // this.id = ahdlist.id;
};

const ahdlist = "SET @endDate := CURDATE(); SELECT (SELECT `name` FROM `address_hierarchy_entry` WHERE `level_id`=2 AND `user_generated_id` = (SELECT property_value FROM global_property WHERE property='partner_reporting_state' )) AS State, (SELECT `name` FROM `address_hierarchy_entry` WHERE `level_id`=3 AND `user_generated_id` = (SELECT property_value FROM global_property WHERE property='partner_reporting_lga_code' )) AS LGA, gp1.property_value as DatimCode, gp2.property_value as FacilityName, patient.patient_id, pid1.identifier as `PatientUniqueID`, pid2.identifier as `PatientHospitalNo`, person.gender as `Sex`, person.birthdate as `DateOfBirth`, TIMESTAMPDIFF(MONTH,getdatevalueobsid(getmaxconceptobsid(patient.patient_id,159599,@endDate)),getobsdatetime(getmaxconceptobsidwithformid(patient.patient_id,162240,27,@endDate))) as MonthsOnART, DATE_FORMAT(getdatevalueobsid(getmaxconceptobsid(patient.patient_id,159599,@endDate)),'%d-%b-%Y') as `ARTStartDate`, DATE_FORMAT(getobsdatetime(getmaxconceptobsidwithformid(patient.patient_id,162240,27,@endDate)),'%d-%b-%Y') as `LastPickupDate`, getconceptval(getmaxconceptobsidwithformid(patient.patient_id,162240,27,@endDate),159368,patient.patient_id) as `DaysOfARVRefil`, DATE_FORMAT(getencounterdate(getlastencounter(patient.patient_id,69,@endDate)),'%d-%b-%Y') as `LastEACDate`, getcodedvalueobsid(getmaxconceptobsidwithformid(patient.patient_id,165708,27,@endDate)) as `CurrentRegimenLine`, getcurrentregimen(getcodedintvalueobs(getmaxconceptobsidwithformid(patient.patient_id,165708,27,@endDate)),getencounterid(getmaxconceptobsidwithformid(patient.patient_id,165708,27,@endDate))) as `CurrentRegimen`, getnumericvalueobsid(getmaxconceptobsidwithformid(patient.patient_id,856,21,@endDate)) as `CurrentViralLoad(c/ml)`, DATE_FORMAT(getobsdatetime(getmaxconceptobsidwithformid(patient.patient_id,856,21,@endDate)),'%d-%b-%Y') as `ViralLoadEncounterDate`, getcodedvalueobsid(getmaxconceptobsidwithformid(patient.patient_id,165470,13,@endDate)) as PatientOutcome, DATE_FORMAT(getobsdatetime(getmaxconceptobsidwithformid(patient.patient_id,165470,13,@endDate)),'%d-%b-%Y') as PatientOutcomeDate, IFNULL (getcodedvalueobsid(getmaxconceptobsidwithformid(patient.patient_id,165470,13,@endDate)),getoutcome( getobsdatetime(getmaxconceptobsidwithformid(patient.patient_id,162240,27,@endDate)), getconceptval(getmaxconceptobsidwithformid(patient.patient_id,162240,27,@endDate),159368,patient.patient_id) , 28, IF(@endDate IS NULL or @endDate = '', CURDATE(),@endDate) )) as `CurrentARTStatus`, getnumericvalueobsid(getmaxconceptobsidwithformid(patient.patient_id,5497,21,@endDate)) as 'CD4+CellCount (cells/mm3)', DATE_FORMAT(getobsdatetime(getmaxconceptobsidwithformid(patient.patient_id,5497,21,@endDate)),'%d-%b-%Y') as 'CD4+CellCountDate', getcodedvalueobsid(getmaxconceptobsidwithformid(patient.patient_id,167088,21,@endDate)) as CD4LFAResult, DATE_FORMAT(getobsdatetime(getmaxconceptobsidwithformid(patient.patient_id,167088,21,@endDate)),'%d-%b-%Y') as CD4LFAResultDate, getcodedvalueobsid(getmaxconceptobsidwithformid(patient.patient_id,166697,21,@endDate)) as TBLFLAMResult, DATE_FORMAT(getobsdatetime(getmaxconceptobsidwithformid(patient.patient_id,166697,21,@endDate)),'%d-%b-%Y') as TBLFLAMResultDate, IF(getcodedintvalueobs(getminconceptobswithformidvaluecoded(patient.patient_id,165974,89,1065,@endDate))='1065', "YES", "NO") as 'Xpert/MTB/RIF Request', DATE_FORMAT(getobsdatetime(getminconceptobswithformidvaluecoded(patient.patient_id,165879,94,162202,@endDate)),'%d-%b-%Y') as 'Xpert/MTB/RIF RequestDate', getcodedvalueobsid(getmaxconceptobsidwithformid(patient.patient_id,166697,21,@endDate)) as 'Xpert/MTB/RIF Result', getcodedvalueobsid(getminconceptobswithformid(patient.patient_id,165304,27,@endDate)) as 'TBTreatment', DATE_FORMAT(getobsdatetime(getminconceptobswithformid(patient.patient_id,165304,27,@endDate)),'%d-%b-%Y') as 'TBTreatmentDate', getcodedvalueobsid(getmaxconceptobsidwithformid(patient.patient_id,167090,21,@endDate)) as SerologyForCrAg, DATE_FORMAT(getobsdatetime(getmaxconceptobsidwithformid(patient.patient_id,167090,21,@endDate)),'%d-%b-%Y') as SerologyForCrAgDate, getcodedvalueobsid(getmaxconceptobsidwithformid(patient.patient_id,167082,21,@endDate)) as CSFForCrAg, DATE_FORMAT(getobsdatetime(getmaxconceptobsidwithformid(patient.patient_id,167082,21,@endDate)),'%d-%b-%Y') as CSFForCrAgDate, IF(getcodedintvalueobs(getminconceptobswithformidvaluecoded(patient.patient_id,165727,27,76488,@endDate))='76488', "YES", "NO") as 'FluconazoleTreatment', DATE_FORMAT(getobsdatetime(getminconceptobswithformidvaluecoded(patient.patient_id,165727,27,76488,@endDate)),'%d-%b-%Y') as 'FluconazoleTreatmentDate', '' as 'LiposomalAmphotericinB', '' as 'LiposomalAmphotericinBDate', DATE_FORMAT(getdatevalueobsid(getmaxconceptobsidwithformid(patient.patient_id,167091,21,@endDate)),'%r') as `TimeCD4LFASampleCollected`, DATE_FORMAT(getdatevalueobsid(getmaxconceptobsidwithformid(patient.patient_id,167092,21,@endDate)),'%r') as `TimeCD4LFAResultReceived`, DATE_FORMAT(getdatevalueobsid(getmaxconceptobsidwithformid(patient.patient_id,167093,21,@endDate)),'%r') as `TimeSerologyForCrAgSampleCollected`, DATE_FORMAT(getdatevalueobsid(getmaxconceptobsidwithformid(patient.patient_id,167094,21,@endDate)),'%r') as `TimeSerologyForCrAgResultReceived`, gettextvalueobsid(getmaxconceptobsidwithformid(patient.patient_id,165394,21,@endDate)) as `LaboratoryRegistrationNo`, getcodedvalueobsid(getmaxconceptobsidwithformid(patient.patient_id,167079,21,@endDate)) as IndicationForAHD from patient INNER JOIN ( select DISTINCT obs.person_id from obs inner join encounter on(encounter.encounter_id=obs.encounter_id and encounter.voided=0) where obs.voided=0 and obs.concept_id IN(167088,166697,167090,167082,167079) and encounter.encounter_datetime<=@endDate ) as target_patients on(target_patients.person_id=patient.patient_id) LEFT JOIN patient_identifier pid1 on(pid1.patient_id=patient.patient_id and patient.voided=0 and pid1.identifier_type=4 and pid1.voided=0) LEFT JOIN patient_identifier pid2 on(pid2.patient_id=patient.patient_id and patient.voided=0 and pid2.identifier_type=5 and pid2.voided=0) LEFT JOIN person on(person.person_id=patient.patient_id and person.voided=0) LEFT JOIN global_property gp1 on(gp1.property='facility_datim_code') LEFT JOIN global_property gp2 on(gp2.property='Facility_Name') WHERE pid1.identifier IS NOT NULL and patient.voided=0 ";
Ahdlist.getAll = (result) => {
    sql.query(ahdlist, (err, res) => {
        if (err) {
            console.log("error: ", err);
            result(null, err);
            return;
        }

        // console.log("ahdlist: ", res);
        result(null, res);
    });
};

module.exports = Ahdlist;